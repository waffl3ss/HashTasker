{{define "head"}}{{end}}

{{define "dashboard-content"}}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
        <hr>
    </div>
</div>

<div class="row" id="statsCards">
    <div class="col-md-3 mb-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="runningJobs">-</h4>
                        <p class="card-text">Running Jobs</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-play-circle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="totalJobs">-</h4>
                        <p class="card-text">Total Jobs</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-list-task fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="activeWorkers">-</h4>
                        <p class="card-text">Active Workers</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-server fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="hashcatProcs">-</h4>
                        <p class="card-text">Hashcat Processes</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-cpu fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-graph-up"></i> System Overview</h5>
            </div>
            <div class="card-body">
                <div id="workersTable" class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Worker</th>
                                <th>Status</th>
                                <th>CPU</th>
                                <th>Memory</th>
                                <th>GPUs Active</th>
                                <th>Last Checkin</th>
                            </tr>
                        </thead>
                        <tbody id="workersTableBody">
                            <tr>
                                <td colspan="6" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Server Status</span>
                    <span class="badge bg-success">Online</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Database</span>
                    <span class="badge bg-success">Connected</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Workers Online</span>
                    <span class="badge bg-info" id="workersOnlineBadge">-</span>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "dashboard-scripts"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadSystemStats();
    
    setInterval(() => {
        loadDashboardStats();
        loadSystemStats();
    }, 30000);
});

function loadDashboardStats() {
    fetch('/api/dashboard/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('runningJobs').textContent = data.running_jobs;
            document.getElementById('totalJobs').textContent = data.total_jobs;
            document.getElementById('activeWorkers').textContent = data.active_workers;
            document.getElementById('hashcatProcs').textContent = data.total_hashcat_procs;
            document.getElementById('workersOnlineBadge').textContent = data.active_workers;
        })
        .catch(error => console.error('Error loading dashboard stats:', error));
}

function loadSystemStats() {
    fetch('/api/system/stats')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('workersTableBody');
            tbody.innerHTML = '';
            
            if (data.workers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No workers online</td></tr>';
                return;
            }
            
            data.workers.forEach(worker => {
                const lastCheckin = new Date(worker.last_checkin);
                const now = new Date();
                const diffSeconds = (now - lastCheckin) / 1000;
                
                const statusBadge = diffSeconds > 60 ? 
                    '<span class="badge bg-danger">Offline</span>' : 
                    '<span class="badge bg-success">Online</span>';
                
                const activeGPUs = worker.gpus ? worker.gpus.filter(gpu => gpu.usage > 0).length : 0;
                
                const row = `
                    <tr>
                        <td><strong>${worker.hostname}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${worker.cpu_usage.toFixed(1)}%</td>
                        <td>${(worker.memory_used / 1024 / 1024 / 1024).toFixed(1)}GB / ${(worker.memory_total / 1024 / 1024 / 1024).toFixed(1)}GB</td>
                        <td>${activeGPUs} / ${worker.gpus ? worker.gpus.length : 0}</td>
                        <td>${formatDateTime(lastCheckin)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        })
        .catch(error => console.error('Error loading system stats:', error));
}

function formatDateTime(date) {
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}
</script>
{{end}}