{{define "head"}}{{end}}

{{define "jobs-content"}}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-list-task"></i> Jobs</h1>
            <a href="/jobs/create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Job
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Status Legend -->
        <div class="card mb-3">
            <div class="card-body py-2">
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <small class="fw-bold text-muted me-2">Status Legend:</small>
                    <div class="d-flex align-items-center gap-1">
                        <span class="badge bg-secondary">Queued</span>
                        <small class="text-muted">Waiting to send chunks to workers</small>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <span class="badge bg-primary">Running</span>
                        <small class="text-muted">Active on workers</small>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <span class="badge bg-success">Completed</span>
                        <small class="text-muted">Finished successfully</small>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <span class="badge bg-warning">Cancelled</span>
                        <small class="text-muted">Stopped by user</small>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <span class="badge bg-danger">Failed</span>
                        <small class="text-muted">Error occurred</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Jobs</h5>
                    <div class="d-flex gap-2">
                        <input type="text" id="jobSearch" class="form-control form-control-sm" placeholder="Search jobs..." style="width: 200px;">
                        <select id="statusFilter" class="form-select form-select-sm" style="width: 150px;">
                            <option value="">All Status</option>
                            <option value="queued">Queued</option>
                            <option value="running">Running</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="jobsTable">
                        <thead>
                            <tr>
                                <th>Job ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Worker Progress</th>
                                <th>Recovered/Total</th>
                                <th>Created At</th>
                                <th>Finished At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="loading-spinner me-2"></div>
                                    Loading jobs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "jobs-scripts"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadJobs();
    
    // Refresh every 60 seconds instead of 30 to reduce server load
    setInterval(loadJobs, 60000);
    
    document.getElementById('jobSearch').addEventListener('input', filterJobs);
    document.getElementById('statusFilter').addEventListener('change', filterJobs);
});

let allJobs = [];

function loadJobs() {
    fetch('/api/jobs')
        .then(response => response.json())
        .then(data => {
            allJobs = data;
            displayJobs(allJobs);
        })
        .catch(error => {
            console.error('Error loading jobs:', error);
            document.getElementById('jobsTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading jobs</td></tr>';
        });
}

function displayJobs(jobs) {
    const tbody = document.getElementById('jobsTableBody');
    
    if (jobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No jobs found</td></tr>';
        return;
    }
    
    tbody.innerHTML = '';
    
    jobs.forEach(job => {
        const statusBadge = getStatusBadge(job.status);
        
        // Build worker progress with time remaining
        let progress = '';
        if (job.worker_progress) {
            progress = `<small class="text-muted">${job.worker_progress}</small>`;
            if (job.time_remaining_str) {
                progress += `<br><small class="text-muted">ETA: ${job.time_remaining_str}</small>`;
            }
        } else {
            progress = '<small class="text-muted">No progress data</small>';
        }
        
        const actions = getActionButtons(job);
        
        const row = `
            <tr>
                <td>
                    <a href="/jobs/${job.uid}" class="text-decoration-none fw-bold">
                        ${job.uid}
                    </a>
                </td>
                <td>
                    <div class="fw-medium">${job.name}</div>
                    <small class="text-muted">by ${job.user ? job.user.username : (job.User ? job.User.username : 'Unknown')}</small>
                </td>
                <td>${statusBadge}</td>
                <td>${progress}</td>
                <td>
                    <span class="badge bg-info">${job.cracked_count}/${job.total_hashes}</span>
                    <div class="progress mt-1" style="height: 6px; background-color: #6c757d;">
                        <div class="progress-bar bg-success" style="width: ${job.total_hashes > 0 ? (job.cracked_count / job.total_hashes * 100) : 0}%"></div>
                    </div>
                </td>
                <td>
                    <small>${formatDateTime(new Date(job.created_at))}</small>
                </td>
                <td>
                    <small>${job.finished_at ? formatDateTime(new Date(job.finished_at)) : '-'}</small>
                </td>
                <td class="table-actions">${actions}</td>
            </tr>
        `;
        
        tbody.innerHTML += row;
    });
}

function getStatusBadge(status) {
    const badges = {
        'queued': '<span class="badge bg-secondary">Queued</span>',
        'running': '<span class="badge bg-primary">Running</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'cancelled': '<span class="badge bg-warning">Cancelled</span>',
        'failed': '<span class="badge bg-danger">Failed</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function getActionButtons(job) {
    let buttons = '';
    
    // Copy job button
    buttons += `<button class="btn btn-outline-info btn-sm me-1" onclick="copyJob('${job.uid}')" title="Copy Job">
        <i class="bi bi-files"></i>
    </button>`;
    
    if (job.status === 'queued' || job.status === 'running') {
        buttons += `<button class="btn btn-outline-warning btn-sm me-1" onclick="cancelJob('${job.uid}')" title="Cancel Job">
            <i class="bi bi-stop-circle"></i>
        </button>`;
    }
    
    buttons += `<button class="btn btn-outline-danger btn-sm" onclick="deleteJob('${job.uid}')" title="Delete Job">
        <i class="bi bi-trash"></i>
    </button>`;
    
    return buttons;
}

function filterJobs() {
    const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    let filtered = allJobs.filter(job => {
        const matchesSearch = !searchTerm || 
            job.name.toLowerCase().includes(searchTerm) ||
            job.uid.toLowerCase().includes(searchTerm) ||
            ((job.user && job.user.username.toLowerCase().includes(searchTerm)) || 
             (job.User && job.User.username.toLowerCase().includes(searchTerm)));
        
        const matchesStatus = !statusFilter || job.status === statusFilter;
        
        return matchesSearch && matchesStatus;
    });
    
    displayJobs(filtered);
}

function copyJob(uid) {
    fetch(`/api/jobs/${uid}/copy`)
        .then(response => response.json())
        .then(data => {
            if (data.name) {
                // Store the job data in sessionStorage to pass to create job page
                sessionStorage.setItem('copyJobData', JSON.stringify(data));
                window.location.href = '/jobs/create';
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error copying job:', error);
            alert('Error copying job');
        });
}

function cancelJob(uid) {
    if (!confirm('Are you sure you want to cancel this job?')) return;
    
    fetch(`/api/jobs/${uid}/cancel`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                loadJobs();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error cancelling job:', error);
            alert('Error cancelling job');
        });
}

function deleteJob(uid) {
    if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) return;
    
    fetch(`/api/jobs/${uid}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                loadJobs();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting job:', error);
            alert('Error deleting job');
        });
}

function formatDateTime(date) {
    return date.toLocaleDateString('en-US', { timeZone: 'UTC' }) + ' ' + 
           date.toLocaleTimeString('en-US', { timeZone: 'UTC' }) + ' UTC';
}
</script>
{{end}}